<!DOCTYPE html>
<html>
	<head>
        <!-- <script src="http://jsbeautifier.org/beautify.js"></script> -->
		<script src="/benchmark.js"></script>
		<script>

        /** Denotes how many seeds we are going to load on to the page */
        var seedCount = {{seedCount}};

        /** How many seeds are we loading on the page? */
        var instanceCount = 0;

        /** A global Benchmark.js suite the YUI modules (unknowingly) pass their tests into */
        var suite = new Benchmark.Suite;

        /** A Y.Benchmark global, for Yeti detection/interaction */
        var YUIBenchmark = null;

        /**
         * Registers a YUI instance with YUI Benchmark
         *
         * @param {Object} A YUI object.
         * @param {Object} Data about this benchmark task/test.
         */
        function registerYUI(YUI, data) {
            var testModulePath = data.modulePath,
                testModuleName = data.name,
                pathToSeedBuild = data.seedBase + '/build/',
                instanceName = data.instanceName,
                sha = data.sha,
                ref = data.ref,
                taskID = data.taskID,
                testID = data.testID,
                YUIConfig = {
                    filter: 'raw',
                    base: pathToSeedBuild,
                    modules: { /** Populated later **/ }
                };

            /** Require a wrapped version of Y.Benchmark */
            YUIConfig.modules['yui-benchmark'] = {
                fullpath: '/task/' + taskID + '/test/' + testID + '/module/yui-benchmark.js',
                requires: ['oop', 'event']
            };

            /** Require the test module */
            YUIConfig.modules[testModuleName] = {
                fullpath: testModulePath,
                requires: ['yui-benchmark']
            };

            YUI(YUIConfig).use(testModuleName, function (Y) {
                var test;

                Y.Benchmark.sha = sha;
                Y.Benchmark.ref = ref;
                Y.Benchmark.taskID = taskID;
                Y.Benchmark.testID = testID;

                if (Y.BenchmarkSuite) {

                    /** Pull off each test in the suite and add it to
                     *  the globally shared Benchmark.js suite **/
                    while (test = Y.BenchmarkSuite.shift()) {
                        /** Add some additional data on to the test for tracking the source */
                        test.sha = sha;
                        test.ref = ref;
                        test.testID = testID;
                        test.taskID = taskID;
                        suite.push(test);
                    }

                    console.log(sha + ': use');

                    if (++instanceCount === seedCount) {
                        /** All the seeds are loaded so we're good to go! */
                        updateUI();
                        executeBenchmarkJSTests();
                    }
                }
            });
        }

        /**
         * Updates the UI before test execution begins
         *
         */
        function updateUI () {

            /*
            console.log(suite);
            var html = '';

            html += '<table border=1>';
            html += '<tr><td>Name</td><td>Seed</td><td>Ops / Sec</td><td>Error Margin</td><td>% slower</td></tr>'

            for(i=0; i < suite.length; i++) {
                html += '<tr><td>' + suite[i].name + '</td><td>' + suite[i].ref + '</td><td></td><td></td><td></td></tr>'
            }
            html += '</table>';
            console.log(html);
            // document.getElementById('testCount').innerHTML = suite.length;
            // document.getElementById('seconds').innerHTML = suite.length * 10;
            // document.getElementById('output').innerHTML = suite[0].compiled * 10;
            Y.one('#dashboard').append(html);
            */
        }

        /**
         * Kicks off the test execution cycle
         *
         */
        function executeBenchmarkJSTests() {
            console.log('ready');
            suite.on('complete', testsComplete);
            suite.on('start', function (event) {
                console.log(suite.length + ' tests');
            });
            suite.on('cycle', function (event) {
                var bench = event.target;
                console.log(bench.id + '/' + suite.length + ': After ' + bench.times.elapsed.toFixed(2) + 's estimates ' + bench.hz.toFixed(2) + 'hz Â±' + bench.stats.rme.toFixed(2) + '% on ' + bench.count + ' samples');
                // console.log(js_beautify(getFunctionBody(bench.setup) + getFunctionBody(bench.fn) + getFunctionBody(bench.teardown)));
            });
            suite.run({async:true});
        }

        /**
         * Gets the body of a function by stripping off the first and last lines
         * Todo: should probably be a regex
         */
        function getFunctionBody (fn) {
            var fnLines = String(fn).split('\n');
            fnLines.reverse().splice(0,1);
            fnLines.reverse().splice(0,1);

            return fnLines.join('\n');
        }

        /**
         * Fires at the conclusion of the suite run.
         * Coallates the results and fire an event that Yeti picks up
         */
        function testsComplete() {
            var benchmark = window.YUIBenchmark,
                test;

            while (test = this.shift()) {
                benchmark.addResult({
                    unit: 'hz',
                    name: test.name,
                    value: test.hz,
                    ref: test.ref,
                    sha: test.sha,
                    testID: test.testID,
                    taskID: test.taskID,
                    stats: test.stats
                });
            }

            /** Requires delay to wait for Yeti to detect this driver */
            setTimeout(function () {
                benchmark.broadcastResults();
            }, 1000);
        }
		</script>

        <!-- Head -->
		{{head}}
        <!-- Head -->

        <script>
            /**
             * This is used to create and globalize an instance of Y.Benchmark
             * using the WIP seed.  Yeti will use this object for driver detection.
             */
            YUI({
                modules: {
                    'yui-benchmark' : {
                        fullpath: '/yui-benchmark.js',
                        requires: ['oop', 'event']
                    }
                }
            }).use('yui-benchmark', function (Y) {
                window.YUIBenchmark = new Y.Benchmark();
            });
        </script>
	</head>

	<body class="yui3-skin-sam">
		<h1>YUI Benchmark</h1>
        <div id="dashboard"></div>

        <!-- Body -->
        {{body}}
        <!-- /Body -->
	</body>
</html>
