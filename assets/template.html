<!DOCTYPE html>
<html>
	<head>
        <!-- <script src="http://jsbeautifier.org/beautify.js"></script> -->
		<script src="/benchmark.js"></script>
		<script>

        /** Denotes how many seeds we are going to load on to the page */
        var seedCount = {{seedCount}}; 

        /** How many seeds are we loading on the page? */
        var instanceCount = 0;
        
        /** A global Benchmark.js suite the YUI modules (unknowingly) pass their tests into */
        var suite = new Benchmark.Suite;

        /** A Y.Benchmark global, for Yeti detection/interaction */
        var YUIBenchmark = null;

        /**
         * Registers a YUI instance with YUI Benchmark
         *
         * @param {Object} A YUI object.
         * @param {Object} Data about this benchmark task/test.
         */
        function registerYUI(YUI, data) {
            var testModulePath = data.modulePath,
                testModuleName = data.name,
                pathToSeedBuild = data.seedBase + '/build/',
                instanceName = data.instanceName,
                YUIConfig = {
                    filter: 'raw',
                    base: pathToSeedBuild,
                    modules: {} // Populated later
                },
                sha = data.sha,
                ref = data.ref,
                taskID = data.taskID,
                testID = data.testID;

            // Require the test module
            YUIConfig.modules[testModuleName] = {
                fullpath: testModulePath
            };

            YUI(YUIConfig).use(testModuleName, function (Y) {
                var test;

                while (test = Y.BenchmarkSuite.shift()) {
                    // Add some additional data on to the test to 
                    test.sha = sha;
                    test.ref = ref;
                    test.testID = testID;
                    test.taskID = taskID;
                    suite.push(test);
                }

                console.log(sha + ': use');

                if (++instanceCount === seedCount) {
                    updateUI();
                    executeTests();
                }
            });
        }

        /**
         * Updates the UI before test execution begins
         * 
         */
        function updateUI () {

            // Adds Y.Benchmark
            YUI.add('benchmark', moduleBenchmark, null, {requires:['oop', 'event']});
            YUI().use('benchmark', function (Y) {
                window.YUIBenchmark = new Y.Benchmark();
            });

            /*
            console.log(suite);
            var html = '';

            html += '<table border=1>';
            html += '<tr><td>Name</td><td>Seed</td><td>Ops / Sec</td><td>Error Margin</td><td>% slower</td></tr>'
            
            for(i=0; i < suite.length; i++) {
                html += '<tr><td>' + suite[i].name + '</td><td>' + suite[i].ref + '</td><td></td><td></td><td></td></tr>'
            }
            html += '</table>';
            console.log(html);
            // document.getElementById('testCount').innerHTML = suite.length;
            // document.getElementById('seconds').innerHTML = suite.length * 10;
            // document.getElementById('output').innerHTML = suite[0].compiled * 10;
            Y.one('#dashboard').append(html);
            */
        }

        /**
         * Kicks off the test execution cycle
         * 
         */
        function executeTests() {
            console.log('-----');
            console.log('ready');
            suite.on('complete', testsComplete);
            suite.on('start', function (event) {
                console.log(suite.length + " tests");
            });
            suite.on('cycle', function (event) {
                var bench = event.target;
                console.log(bench.id + '/' + suite.length + ': After ' + bench.times.elapsed.toFixed(2) + 's estimates ' + bench.hz.toFixed(2) + 'hz Â±' + bench.stats.rme.toFixed(2) + '% on ' + bench.count + ' samples');
                // console.log(js_beautify(getFunctionBody(bench.setup) + getFunctionBody(bench.fn) + getFunctionBody(bench.teardown)));
            });
            suite.run({async:true});
        }

        function getFunctionBody (fn) {
            var fnLines = String(fn).split('\n');
            fnLines.reverse().splice(0,1);
            fnLines.reverse().splice(0,1);

            return fnLines.join('\n');
        }

        /** 
         * Fires at the conclusion of the suite run. 
         * Coallates the results and fire an event that Yeti picks up
         */
        function testsComplete() {
            var benchmark = window.YUIBenchmark,
                test;

            while (test = this.shift()) {
                benchmark.addResult({
                    name: test.name,
                    value: test.hz,
                    ref: test.ref,
                    sha: test.sha,
                    testID: test.testID,
                    taskID: test.taskID,
                    stats: test.stats
                });
            }

            /** Requires delay to wait for Yeti to detect this driver */
            setTimeout(function () {
                benchmark.broadcastResults();
            }, 1000);
        }

        /**
         * A YUI module that exports Y.Benchmark
         *
         * @param {Object} A Y instance
         * @param {Object} The name of this module
         */
        function moduleBenchmark(Y, NAME) {

            /** 
             * Y.Benchmark constructor
             *
             */
            function YBenchmark() { }

            /** An array of results */
            YBenchmark.prototype.results = [];

            /** 
             * Adds a result onto this instance's results set
             * 
             * @param {Object} An object of test results 
             */
            YBenchmark.prototype.addResult = function (result) {
                this.results.push(result);
            }
            
            /** 
             * Broadcasts the `results` event to anyone listening (aka: Yeti)
             *
             */
            YBenchmark.prototype.broadcastResults = function () {
                Y.log('Results\n---');
                Y.log(this.results);
                this.fire('results', {results: this.results});
            }

            /** Add EventTarget into Y.Benchmark */
            Y.augment(YBenchmark, Y.EventTarget);

            /** Export it */
            Y.Benchmark = YBenchmark;
        }
		</script>

        <!-- Head -->
		{{head}}
        <!-- Head -->
	</head>

	<body class="yui3-skin-sam">
		<h1>YUI Benchmark</h1>
        <div id="dashboard"></div>

        <!-- Body -->
        {{body}}
        <!-- /Body -->
	</body>
</html>